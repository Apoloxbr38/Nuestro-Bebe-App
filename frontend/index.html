<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sexy Sports Predictor ⚽✨</title>
  <base href="/app/">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --bg:#0b0d12; --panel:#11151d; --muted:#9aa3b2; --text:#e6eaf2;
      --brand:#8b5cf6; --brand2:#06b6d4; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --ring: 0 0 0 2px hsl(255 85% 65% / .35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 80% -10%, #13203a 0%, transparent 60%),
        radial-gradient(1000px 600px at -10% 90%, #1e123a 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      font:16px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    }
    .container{max-width:1280px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;margin:8px 0 18px}
    .brandlock img{height:42px;border-radius:10px}
    .brandlock .ttl{font-size:26px;font-weight:800;letter-spacing:.3px}
    .muted{color:var(--muted)}

    .card{background:color-mix(in oklab,var(--panel) 86%,black 14%);
      border:1px solid #1c2230;border-radius:20px;padding:20px;box-shadow:0 8px 30px #0008}
    .card h2{margin:0 0 12px;font-size:18px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    @media (max-width:900px){.col-4,.col-6,.col-8{grid-column:span 12}}

    .hero3{display:grid;grid-template-columns:5fr 7fr 4fr;gap:18px}
    @media (max-width:1200px){.hero3{grid-template-columns:1fr 1fr}}
    @media (max-width:900px){.hero3{grid-template-columns:1fr}}

    label{display:block;margin:0 0 6px;font-size:13px;color:var(--muted)}
    select,input,button{width:100%;padding:12px 14px;border-radius:12px;background:#0f1420;border:1px solid #20283a;color:var(--text)}
    select:focus,input:focus,button:focus{outline:none;box-shadow:var(--ring);border-color:#5b70ff}
    .btn{cursor:pointer;font-weight:700;letter-spacing:.3px;background:linear-gradient(135deg,var(--brand),var(--brand2));border:none;color:white;transition:.2s transform,.2s filter}
    .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{display:inline-flex;gap:10px;align-items:center;background:#0e1320;border:1px solid #20283a;padding:8px 12px;border-radius:999px}
    .pill.stat{justify-content:space-between;margin:6px 0;font-size:13px}
    .pill.stat b{font-variant-numeric:tabular-nums}
    .ok{color:var(--ok)} .warning{color:var(--warn)} .err{color:var(--err)}

    .prob-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:620px){.prob-cards{grid-template-columns:1fr}}
    .prob{padding:14px;border-radius:16px;border:1px solid #1b2232;background:#0f1522}
    .prob h4{margin:0 0 6px;font-size:13px;color:var(--muted)}
    .prob .p{font-size:24px;font-weight:800}

    .crests{display:flex;gap:24px;align-items:center;justify-content:flex-start;margin:18px 0}
    .crest{display:grid;place-items:center;width:80px;height:80px;border-radius:18px;background:#0e1320;border:1px solid #20283a;box-shadow:0 8px 30px #0006}
    .crest img{max-height:56px;max-width:56px}

    .win{font-weight:800;color:#22c55e} .loss{color:#9aa3b2} .draw{color:#e6eaf2} .score{font-weight:700}

    footer{margin:28px 0 14px;text-align:center;color:#7f8798;font-size:13px}
    a{color:#a7b5ff;text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>
<header class="app-header">
  <div class="brandlock">
    <img src="assets/ssp-mark.png" alt="Logo">
    <div class="ttl">Sexy Sports Predictor</div>
  </div>
</header>

<div class="container">

  <!-- ===== TOP: 3 columnas ===== -->
  <section class="hero3">
    <!-- IZQUIERDA -->
    <div class="card">
      <h2>Configura tu predicción</h2>
      <div class="grid">
        <div class="col-6">
          <label for="league">Liga</label>
          <select id="league"></select>
        </div>
        <div class="col-6" style="display:flex;align-items:flex-end;justify-content:flex-end">
          <button id="reload" class="btn" style="min-width:180px">🔄 Cargar ligas</button>
        </div>
        <div class="col-6">
          <label for="home">Local</label>
          <select id="home"></select>
        </div>
        <div class="col-6">
          <label for="away">Visita</label>
          <select id="away"></select>
        </div>
        <div class="col-12" style="margin-top:8px">
          <button id="predict" class="btn" style="width:100%;padding:14px 18px;font-size:16px">✨ Predecir partido</button>
        </div>
      </div>
      <div id="hint" class="muted" style="margin-top:10px;font-size:13px">
        Sugerencia: primero elige la liga y luego los equipos.
      </div>

      <!-- Escudos -->
      <div class="crests">
        <div class="crest"><img id="crestHome" alt="Home"></div>
        <div class="crest"><img id="crestAway" alt="Away"></div>
      </div>
    </div>

    <!-- CENTRO -->
    <div class="card">
      <h2>Distribución de probabilidades</h2>
      <canvas id="chart" height="220"></canvas>
    </div>

    <!-- DERECHA -->
    <div class="card">
      <h2>Estado del sistema</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="pill"><span>API:</span> <strong id="apiState" class="warning">comprobando…</strong></div>
        <div class="pill"><span>Equipos:</span> <strong id="apiTeams" class="muted">—</strong></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div class="pill stat">⚽ xG Local: <b id="sb_xgh">—</b></div>
        <div class="pill stat">⚽ xG Visita: <b id="sb_xga">—</b></div>
        <div class="pill stat">📊 Total xG: <b id="sb_xgt">—</b></div>
        <div class="pill stat">📈 Over 2.5: <b id="sb_over">—</b></div>
        <div class="pill stat">📉 Under 2.5: <b id="sb_under">—</b></div>
        <div class="pill stat">🔔 BTTS Sí: <b id="sb_bttsYes">—</b></div>
        <div class="pill stat">🔕 BTTS No: <b id="sb_bttsNo">—</b></div>
        <div class="pill stat">🚩 Córners Local: <b id="sb_cornh">—</b></div>
        <div class="pill stat">🚩 Córners Visita: <b id="sb_corna">—</b></div>
        <div class="pill stat">📊 Total: <b id="sb_cort">—</b></div>
        <div class="pill stat">⬆️ Over 9.5: <b id="sb_corOver">—</b></div>
        <div class="pill stat">⬇️ Under 9.5: <b id="sb_corUnder">—</b></div>
        <div class="pill stat">🟨 Amarillas Local: <b id="sb_yelh">—</b></div>
        <div class="pill stat">🟨 Amarillas Visita: <b id="sb_yela">—</b></div>
        <div class="pill stat">📊 Total: <b id="sb_yelt">—</b></div>
        <div class="pill stat">⬆️ Over 4.5: <b id="sb_yelOver">—</b></div>
        <div class="pill stat">⬇️ Under 4.5: <b id="sb_yelUnder">—</b></div>
        <div class="pill stat">🟥 Rojas Local: <b id="sb_redh">—</b></div>
        <div class="pill stat">🟥 Rojas Visita: <b id="sb_reda">—</b></div>
        <div class="pill stat">📊 Total: <b id="sb_redt">—</b></div>
        <div class="pill stat">⚽ Goles =0: <b id="sb_g0">—</b></div>
        <div class="pill stat">⚽ Goles =1: <b id="sb_g1">—</b></div>
        <div class="pill stat">⚽ Goles =2: <b id="sb_g2">—</b></div>
        <div class="pill stat">⚽ Goles 3+: <b id="sb_g3p">—</b></div>
      </div>
    </div>
  </section>

  <!-- ===== RESUMEN ===== -->
  <section class="grid" style="margin-top:18px">
    <div class="col-12">
      <div class="card">
        <h2>Resumen</h2>
        <div class="prob-cards">
          <div class="prob"><h4>🏠 Local</h4><div class="p" id="p_home">—</div></div>
          <div class="prob"><h4>🤝 Empate</h4><div class="p" id="p_draw">—</div></div>
          <div class="prob"><h4>🛫 Visita</h4><div class="p" id="p_away">—</div></div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">⚽ xG Local: <b id="xgh">—</b></span>
          <span class="pill">⚽ xG Visita: <b id="xga">—</b></span>
          <span class="pill">📊 Total xG: <b id="xgt">—</b></span>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">📈 Over 2.5: <b id="over">—</b></span>
          <span class="pill">📉 Under 2.5: <b id="under">—</b></span>
          <span class="pill">🔔 BTTS Sí: <b id="bttsYes">—</b></span>
          <span class="pill">🔕 BTTS No: <b id="bttsNo">—</b></span>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">🚩 Córners Local: <b id="cornh">—</b></span>
          <span class="pill">🚩 Córners Visita: <b id="corna">—</b></span>
          <span class="pill">📊 Total: <b id="cort">—</b></span>
          <span class="pill">⬆️ Over 9.5: <b id="corOver">—</b></span>
          <span class="pill">⬇️ Under 9.5: <b id="corUnder">—</b></span>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">🟨 Amarillas Local: <b id="yelh">—</b></span>
          <span class="pill">🟨 Amarillas Visita: <b id="yela">—</b></span>
          <span class="pill">📊 Total: <b id="yelt">—</b></span>
          <span class="pill">⬆️ Over 4.5: <b id="yelOver">—</b></span>
          <span class="pill">⬇️ Under 4.5: <b id="yelUnder">—</b></span>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">🟥 Rojas Local: <b id="redh">—</b></span>
          <span class="pill">🟥 Rojas Visita: <b id="reda">—</b></span>
          <span class="pill">📊 Total: <b id="redt">—</b></span>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">⚽ Goles =0: <b id="g0">—</b></span>
          <span class="pill">⚽ Goles =1: <b id="g1">—</b></span>
          <span class="pill">⚽ Goles =2: <b id="g2">—</b></span>
          <span class="pill">⚽ Goles 3+: <b id="g3p">—</b></span>
        </div>

        <div class="muted" style="margin-top:12px;font-size:12px">
          Fuentes: 1X2 <span id="src1x2">—</span> · O/U <span id="srcou">—</span> · BTTS <span id="srcbtts">—</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== LIVE CARD ===== -->
  <section class="card" style="margin-top:18px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h2>🎯 Seguimiento en Vivo</h2>
      <div class="row">
        <span class="pill">Tiempo real</span>
        <span class="pill">Sexy Mode</span>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="matchIdInput" type="text" placeholder="Ej: Sexy FC:Romance United o BHA:ARS" />
      <button id="btnStartLive" class="btn" style="max-width:200px">Empezar</button>
      <button id="btnStopLive" style="max-width:200px">Detener</button>
    </div>

    <div class="scoreboard" style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;margin-top:10px">
      <div class="team" id="homeName">—</div>
      <div class="score" style="font-size:28px"><span id="homeScore">0</span> : <span id="awayScore">0</span></div>
      <div class="team" id="awayName">—</div>
    </div>

    <div class="live-meta" style="margin-top:6px">
      <span class="pill" id="statusChip">NS</span>
      <span class="pill" id="minuteChip">0’</span>
    </div>

    <div class="ticker" id="liveTicker" style="margin-top:10px">
      <div class="muted" id="tickerLine">Esperando partido…</div>
    </div>
  </section>

  <!-- ===== Tabla últimos partidos ===== -->
  <section class="grid" style="margin-top:18px">
    <div class="col-12">
      <div class="card">
        <h2>🗓️ Últimos 10 partidos (global)</h2>
        <div class="muted" id="recentHint" style="margin-bottom:8px">Cargando…</div>
        <div style="overflow:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="text-align:left;border-bottom:1px solid #1b2232">
                <th style="padding:8px">Fecha</th>
                <th style="padding:8px">Liga</th>
                <th style="padding:8px">Local</th>
                <th style="padding:8px">Marcador</th>
                <th style="padding:8px">Visita</th>
              </tr>
            </thead>
            <tbody id="recentBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <footer>
    Hecho con 💜 por nosotros · <a href="/docs" target="_blank">API Docs</a>
  </footer>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- ===== JS ÚNICO ===== -->
<script>
/* ===== Utils ===== */
const $ = (q) => document.querySelector(q);
const api = (p, opt) => fetch(p, opt).then(r => { if(!r.ok) throw new Error(r.status); return r.json(); });
const DEFAULT_LEAGUES = ["SP1","E0","I1","D1","F1","N1","SC1","P1","B1"];
const LEAGUE_NAMES = { SP1:'LaLiga (ES)', E0:'Premier (EN)', I1:'Serie A (IT)', D1:'Bundesliga (DE)', F1:'Ligue 1 (FR)', N1:'Eredivisie (NL)', SC1:'Scottish Prem (UK)', P1:'Primeira (PT)', B1:'Jupiler Pro (BE)' };
const fmtPct = (x) => (Number.isFinite(Number(x)) ? (Number(x)*100).toFixed(1)+'%' : '—');
const safeNum = (x) => { const v = Number(x); return Number.isFinite(v) ? v : null; };

/* ===== Chart ===== */
let chart;
function renderChart(ph, pd, pa){
  const ctx = document.getElementById('chart');
  if (!ctx || typeof Chart === 'undefined') return;
  const data = { labels:['Local','Empate','Visita'], datasets:[{ label:'Prob', data:[ph,pd,pa] }] };
  const options = { responsive:true, scales:{ y:{ beginAtZero:true, max:1 } }, plugins:{ legend:{ display:false } } };
  if(chart){ chart.data = data; chart.update(); }
  else { chart = new Chart(ctx, { type:'bar', data, options }); }
}

/* ===== Escudos ===== */
const TEAM_ALIASES = {
  "Real Madrid":"real-madrid","Barcelona":"barcelona","Atlético Madrid":"atletico-madrid",
  "Ath Bilbao":"athletic-bilbao","Celta Vigo":"celta","Nott'm Forest":"nottingham-forest",
  "Man United":"manchester-united","Man City":"manchester-city"
};
function slugifyTeam(name){
  if(!name) return "";
  if(TEAM_ALIASES[name]) return TEAM_ALIASES[name];
  return name.toLowerCase()
             .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
             .replace(/[^a-z0-9]+/g,'-')
             .replace(/(^-|-$)/g,'');
}
function setCrests(home, away){
  const imgH = document.getElementById('crestHome');
  const imgA = document.getElementById('crestAway');
  const base = 'assets/crests/';
  const fallback = base + '_default.png';
  const safeSet = (img, src) => { if(!img) return; img.onerror=()=>{img.onerror=null;img.src=fallback}; img.src=src; };
  safeSet(imgH, base + slugifyTeam(home) + '.png');
  safeSet(imgA, base + slugifyTeam(away) + '.png');
}
function updateCrestsFromSelects(){
  const home = $('#home')?.value || '';
  const away = $('#away')?.value || '';
  setCrests(home, away);
}

/* ===== Sidebar chips ===== */
function renderSidebarMetrics(r){
  const set = (id, val, asPct=false) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (val==null || (asPct && isNaN(val))) ? '—' : (asPct ? (val*100).toFixed(1)+'%' : val);
  };
  set('sb_xgh', r.exp_goals_home);
  set('sb_xga', r.exp_goals_away);
  set('sb_xgt', r.exp_goals_total);
  set('sb_over', r.ou_over25, true);
  set('sb_under', r.ou_under25, true);
  set('sb_bttsYes', r.btts_yes, true);
  set('sb_bttsNo',  r.btts_no,  true);
  set('sb_cornh', r.exp_corners_home);
  set('sb_corna', r.exp_corners_away);
  set('sb_cort',  r.exp_corners_total);
  set('sb_corOver',  r.corners_over95,  true);
  set('sb_corUnder', r.corners_under95, true);
  set('sb_yelh', r.exp_yellows_home);
  set('sb_yela', r.exp_yellows_away);
  set('sb_yelt', r.exp_yellows_total);
  set('sb_yelOver',  r.yellows_over45,  true);
  set('sb_yelUnder', r.yellows_under45, true);
  set('sb_redh', r.exp_reds_home);
  set('sb_reda', r.exp_reds_away);
  set('sb_redt', r.exp_reds_total);
  set('sb_g0',  r.p_goals_0,     true);
  set('sb_g1',  r.p_goals_1,     true);
  set('sb_g2',  r.p_goals_2,     true);
  set('sb_g3p', r.p_goals_3plus, true);
}

/* ===== Init + Health + Ligas ===== */
async function init(){
  try{
    const h = await api('/health');
    $('#apiState').textContent = 'OK'; $('#apiState').className = 'ok';
    $('#apiTeams').textContent = h.teams?.length ?? '—';
  }catch(e){ $('#apiState').textContent = 'Error'; $('#apiState').className = 'err'; }

  try{
    const l = await api('/leagues');
    const sel = $('#league'); sel.innerHTML = '';
    const opt0 = document.createElement('option'); opt0.text = '— Selecciona liga —'; opt0.value=''; sel.appendChild(opt0);
    (l.leagues||[]).forEach(code=>{
      const o=document.createElement('option'); o.value = code; o.text = LEAGUE_NAMES[code] || code; sel.appendChild(o);
    });
  }catch(e){ console.warn('leagues', e); }
}

/* ===== Equipos por liga ===== */
async function loadTeams(){
  const lg = $('#league').value;
  const homeSel = $('#home'), awaySel = $('#away');
  if(!lg){ homeSel.innerHTML=''; awaySel.innerHTML=''; updateCrestsFromSelects(); return; }
  const t = await api('/teams?league='+encodeURIComponent(lg));
  const teams = t.teams || [];
  const fill = (el) => { el.innerHTML=''; teams.forEach(x=>{ const o=document.createElement('option'); o.value=o.text=x; el.appendChild(o); }); };
  fill(homeSel); fill(awaySel);
  if(teams.length>=2){ homeSel.value = teams[0]; awaySel.value = teams[1]; }
  updateCrestsFromSelects();
}

/* ===== Predecir ===== */
async function doPredict(){
  try{
    const home = $('#home')?.value;
    const away = $('#away')?.value;
    if(!home || !away || home===away){ alert('Elige dos equipos distintos'); return; }

    const r = await api(`/predict?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}`);

    // KPIs principales
    $('#p_home').textContent = fmtPct(safeNum(r.p_home));
    $('#p_draw').textContent = fmtPct(safeNum(r.p_draw));
    $('#p_away').textContent = fmtPct(safeNum(r.p_away));

    // Resumen chips
    $('#xgh').textContent = r.exp_goals_home ?? '—';
    $('#xga').textContent = r.exp_goals_away ?? '—';
    $('#xgt').textContent = r.exp_goals_total ?? '—';
    $('#over').textContent = fmtPct(safeNum(r.ou_over25));
    $('#under').textContent = fmtPct(safeNum(r.ou_under25));
    $('#bttsYes').textContent = fmtPct(safeNum(r.btts_yes));
    $('#bttsNo').textContent  = fmtPct(safeNum(r.btts_no));
    $('#src1x2').textContent = r.src_1x2 || '—';
    $('#srcou').textContent  = r.src_ou25 || '—';
    $('#srcbtts').textContent= r.src_btts || '—';

    // Más chips
    $('#cornh').textContent = r.exp_corners_home ?? '—';
    $('#corna').textContent = r.exp_corners_away ?? '—';
    $('#cort').textContent  = r.exp_corners_total ?? '—';
    $('#corOver').textContent  = fmtPct(safeNum(r.corners_over95));
    $('#corUnder').textContent = fmtPct(safeNum(r.corners_under95));
    $('#yelh').textContent = r.exp_yellows_home ?? '—';
    $('#yela').textContent = r.exp_yellows_away ?? '—';
    $('#yelt').textContent = r.exp_yellows_total ?? '—';
    $('#yelOver').textContent  = fmtPct(safeNum(r.yellows_over45));
    $('#yelUnder').textContent = fmtPct(safeNum(r.yellows_under45));
    $('#redh').textContent = r.exp_reds_home ?? '—';
    $('#reda').textContent = r.exp_reds_away ?? '—';
    $('#redt').textContent = r.exp_reds_total ?? '—';
    $('#g0').textContent  = fmtPct(safeNum(r.p_goals_0));
    $('#g1').textContent  = fmtPct(safeNum(r.p_goals_1));
    $('#g2').textContent  = fmtPct(safeNum(r.p_goals_2));
    $('#g3p').textContent = fmtPct(safeNum(r.p_goals_3plus));

    // Gráfico + sidebar + escudos
    renderChart(safeNum(r.p_home) ?? 0, safeNum(r.p_draw) ?? 0, safeNum(r.p_away) ?? 0);
    renderSidebarMetrics(r);
    setCrests(home, away);
  }catch(err){
    console.error('doPredict error:', err);
    alert('No se pudo generar la predicción. Revisa la consola (F12).');
  }
}

/* ===== Recargar datos (multi ligas) ===== */
async function reloadLeagues(){
  const btn = $('#reload'); btn.disabled = true; btn.textContent = 'Cargando…';
  try{
    const body = { leagues: DEFAULT_LEAGUES, last_n: 5 };
    const r = await fetch('/reload_multi',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const j = await r.json();
    const years = (typeof j.years === 'string') ? j.years : (Array.isArray(j.years) ? j.years.join(', ') : '—');
    const lg = body.leagues.map(c=>LEAGUE_NAMES[c]||c).join(', ');
    $('#hint').textContent = `✅ Recargado: ${j.rows ?? '?'} partidos · Ligas: ${lg} · Años: ${years}`;
    await init();
  }catch(err){ alert('No se pudo recargar datos. Revisa el servidor.'); }
  btn.disabled = false; btn.textContent = '🔄 Cargar ligas';
}

/* ===== Últimos 10 partidos (tabla) ===== */
async function loadRecent(limit=10){
  const hint = $('#recentHint');
  const tbody = $('#recentBody');
  hint.textContent = 'Cargando…'; tbody.innerHTML = '';
  try{
    const data = await api(`/recent?limit=${encodeURIComponent(limit)}`);
    const list = Array.isArray(data?.matches) ? data.matches : [];
    if(list.length===0){ hint.textContent='No hay partidos recientes.'; return; }
    hint.textContent = `Mostrando ${list.length} más recientes`;
    const rows = list.map(m=>{
      const d = (m.Date || '').toString();
      const lg = (m.League || '').toString();
      const ht = (m.HomeTeam || '').toString();
      const at = (m.AwayTeam || '').toString();
      const hg = (m.FTHG ?? '—');
      const ag = (m.FTAG ?? '—');
      return `<tr>
        <td style="padding:8px">${d}</td>
        <td style="padding:8px">${lg}</td>
        <td style="padding:8px">${ht}</td>
        <td style="padding:8px" class="score">${hg}:${ag}</td>
        <td style="padding:8px">${at}</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows;
  }catch(e){
    hint.textContent = 'No se pudieron cargar los recientes.';
  }
}

/* ===== Live tracking (WebSocket) ===== */
(() => {
  let ws = null, running = false;
  const homeName = document.getElementById("homeName");
  const awayName = document.getElementById("awayName");
  const homeScore = document.getElementById("homeScore");
  const awayScore = document.getElementById("awayScore");
  const statusChip = document.getElementById("statusChip");
  const minuteChip = document.getElementById("minuteChip");
  const tickerLine = document.getElementById("tickerLine");

  function pushTicker(msg) {
    const now = new Date().toLocaleTimeString();
    tickerLine.textContent = `[${now}] ${msg} — ` + tickerLine.textContent;
  }

  function applyEvent(ev) {
    homeName.textContent = ev.home;
    awayName.textContent = ev.away;
    homeScore.textContent = ev.score_home;
    awayScore.textContent = ev.score_away;
    statusChip.textContent = ev.status;
    minuteChip.textContent = `${ev.minute}’`;
    if (ev.home && ev.away) setCrests(ev.home, ev.away);

    if (ev.incident) {
      const map = {
        GOAL_HOME: `¡GOL de ${ev.home}!`,
        GOAL_AWAY: `¡GOL de ${ev.away}!`,
        YELLOW_HOME: `Amarilla para ${ev.home}`,
        YELLOW_AWAY: `Amarilla para ${ev.away}`,
        RED_HOME: `Roja para ${ev.home}`,
        RED_AWAY: `Roja para ${ev.away}`,
      };
      pushTicker(map[ev.incident] || ev.incident);
    }
  }

  function startLive() {
    const input = (document.getElementById("matchIdInput").value || "Sexy FC:Romance United").trim();
    const url = `ws://localhost:8000/live/ws?match_id=${encodeURIComponent(input)}`;
    if (ws) { ws.close(); ws = null; }
    ws = new WebSocket(url);
    running = true;
    pushTicker(`Conectando a ${input}…`);
    ws.onopen = () => pushTicker("Conexión establecida 💜");
    ws.onmessage = (evt) => {
      const msg = JSON.parse(evt.data);
      if (msg.type === "event") applyEvent(msg.data);
      if (msg.type === "close") { pushTicker("Partido finalizado (FT)"); stopLive(); }
    };
    ws.onclose = () => { if (running) pushTicker("Conexión cerrada"); running = false; };
    ws.onerror = () => pushTicker("Error de conexión");
  }

  function stopLive() {
    running = false;
    if (ws) { ws.close(); ws = null; }
    pushTicker("Detenido por el usuario.");
  }

  document.getElementById("btnStartLive").addEventListener("click", startLive);
  document.getElementById("btnStopLive").addEventListener("click", stopLive);
})();

/* ===== Arranque ===== */
document.addEventListener('DOMContentLoaded', async () => {
  try{
    await init();
    await loadRecent(10);

    // Selecciona primera liga y equipos + predice
    const sel = document.getElementById('league');
    if (sel && sel.options.length > 1){
      sel.selectedIndex = 1;
      await loadTeams();

      const h = document.getElementById('home');
      const a = document.getElementById('away');
      if (h && a && h.options.length && a.options.length){
        const pick = (el, name) => { const idx = [...el.options].findIndex(o => o.value === name); if (idx >= 0) el.selectedIndex = idx; };
        pick(h, 'Real Madrid'); pick(a, 'Barcelona');
        if (h.value && a.value && h.value === a.value && a.options.length > 1){
          a.selectedIndex = (h.selectedIndex + 1) % a.options.length;
        }
        updateCrestsFromSelects();
        await doPredict();
      }
    }

    document.getElementById('league')?.addEventListener('change', async () => { await loadTeams(); });
    document.getElementById('home')?.addEventListener('change', updateCrestsFromSelects);
    document.getElementById('away')?.addEventListener('change', updateCrestsFromSelects);
    document.getElementById('reload')?.addEventListener('click', reloadLeagues);
    document.getElementById('predict')?.addEventListener('click', doPredict);
  }catch(e){
    console.error('DOMContentLoaded init error:', e);
  }
});
</script>
</body>
</html>
